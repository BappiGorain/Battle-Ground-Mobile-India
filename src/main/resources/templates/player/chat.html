<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BGMI ‚Äî Player Chat</title>
  <meta name="color-scheme" content="dark"/>
  <style>
    body{font-family:Inter,system-ui,Roboto,Arial;background:#071227;color:#eaf0f8}
    .container{max-width:920px;margin:24px auto}
  </style>
</head>
<body>


     

  <div class="container">
    <header>
      <h1>BGMI ‚Äî Player Chat</h1>
    </header>

        

    <!-- ‚ö†Ô∏è Warning message -->
<div style="
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  background: linear-gradient(135deg, #facc15, #f59e0b);
  color: #1a1a1a;
  font-size: 15px;
  font-weight: 600;
  padding: 12px 16px;
  border-radius: 10px;
  margin: 10px 0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  border: 1px solid #92400e;
">
  <span style="font-size: 20px;">‚ö†Ô∏è</span>
  <span>
    Do <span style="text-decoration: underline; color: #b91c1c;">not refresh</span> this page otherwise
    all chat history will be <span style="color:#dc2626; font-weight:700;">lost</span>!
  </span>
  
</div>

    <div style="
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  background: linear-gradient(135deg, #20c855, #73e006);
  color: #1a1a1a;
  font-size: 15px;
  font-weight: 600;
  padding: 12px 16px;
  border-radius: 10px;
  margin: 10px 0;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  border: 1px solid #92400e;
">
  <span style="font-size: 20px;"></span>
  <span>
     <span style="text-decoration: underline; color: #b91c1c;">Player Count </span> will change if  
     <span style="color:#dc2626; font-weight:700;">new</span> player enters
  </span>
</div>
    
    
    <div id="statusBar" style="display:flex;justify-content:space-between;align-items:center;margin:12px 0;">
      <div id="connection-status" style="font-weight:700;color:crimson">Connecting‚Ä¶</div>
      <div style="background:#1e293b;padding:6px 10px;border-radius:6px;color:#cbd5e1">Players online: <span id="numberOfPlayers">0</span></div>
    </div>

    <div id="chat-messages" style="min-height:300px;max-height:520px;overflow:auto;padding:12px;border:1px solid #253a5a;border-radius:8px;background:#071227"></div>

    <form id="chat-form" style="display:flex;gap:8px;margin-top:12px;">
      <input id="chat-input" type="text" placeholder="Type a message..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #253a5a;background:#0f1724;color:#eaf0f8" disabled />
      <button id="send-btn" type="submit" disabled style="padding:10px 14px;border-radius:8px;background:#3b82f6;border:none;color:#071223;font-weight:800">Send</button>
    </form>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

  <script>
    const statusEl = document.getElementById('connection-status');
    const playersEl = document.getElementById('numberOfPlayers');
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');

    let stompClient = null;
    let connected = false;
    const username = 'Player_' + Math.floor(Math.random() * 10000);

    function setConnected(val) {
      connected = val;
      if (val) {
        statusEl.textContent = 'Connected as ' + username;
        statusEl.style.color = '#10b981';
        chatInput.disabled = false;
        sendBtn.disabled = false;
      } else {
        statusEl.textContent = 'Disconnected';
        statusEl.style.color = '#ef4444';
        chatInput.disabled = true;
        sendBtn.disabled = true;
      }
    }

    function updatePlayerCount(count) {
      playersEl.textContent = count;
      console.log('Player count updated to:', count);
    }

    function parseCountPayload(body) {
      try {
        const parsed = JSON.parse(body);
        if (typeof parsed === 'number') return parsed;
        if (parsed && parsed.count !== undefined) return Number(parsed.count);
        return 0;
      } catch {
        return parseInt(body) || 0;
      }
    }

    function showMessage(message) {
      const el = document.createElement('div');
      el.style.marginBottom = '8px';
      el.style.maxWidth = '75%';
      el.style.padding = '10px';
      el.style.borderRadius = '10px';
      el.style.wordBreak = 'break-word';

      if (message.sender === username) {
        el.style.marginLeft = 'auto';
        el.style.background = 'linear-gradient(135deg,#3b82f6,#8b5cf6)';
        el.style.color = '#fff';
      } else {
        el.style.background = '#0f1724';
        el.style.border = '1px solid #253a5a';
        el.style.color = '#eaf0f8';
      }

      const text = document.createElement('div');
      text.textContent = message.content;
      const meta = document.createElement('div');
      meta.style.fontSize = '12px';
      meta.style.color = '#9aa8c6';
      meta.style.marginTop = '6px';
      meta.textContent = (message.sender === username ? 'You' : message.sender) + ' ‚Ä¢ ' + (message.timestamp || new Date().toLocaleTimeString());

      el.appendChild(text);
      el.appendChild(meta);
      chatMessages.appendChild(el);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function connect() {
      setConnected(false);
      const socket = new SockJS('/chat');
      stompClient = Stomp.over(socket);

      stompClient.connect({}, frame => {
        console.log('Connected:', frame);
        setConnected(true);

        stompClient.subscribe('/topic/messages', msg => {
          try {
            showMessage(JSON.parse(msg.body));
          } catch (e) {
            console.error('Invalid /topic/messages payload', msg.body);
          }
        });

        stompClient.subscribe('/topic/players', update => {
          try {
            updatePlayerCount(parseCountPayload(update.body));
          } catch (e) {
            console.error('Invalid /topic/players payload', update.body);
          }
        });

        // üî• Ask server for the latest player count immediately
        stompClient.send("/app/requestPlayerCount", {}, {});

        // Broadcast join notification
        const sys = { sender: 'System', content: username + ' joined the battle', timestamp: new Date().toLocaleTimeString() };
        stompClient.send('/app/sendMessage', {}, JSON.stringify(sys));

      }, err => {
        console.error('STOMP error', err);
        setConnected(false);
        setTimeout(connect, 3000);
      });
    }

    chatForm.addEventListener('submit', ev => {
      ev.preventDefault();
      const text = chatInput.value.trim();
      if (!text || !stompClient || !connected) return;
      const msg = { sender: username, content: text, timestamp: new Date().toLocaleTimeString() };
      stompClient.send('/app/sendMessage', {}, JSON.stringify(msg));
      chatInput.value = '';
    });

    window.addEventListener('beforeunload', () => {
      if (stompClient && connected) {
        const sys = { sender: 'System', content: username + ' left the battle', timestamp: new Date().toLocaleTimeString() };
        try { stompClient.send('/app/sendMessage', {}, JSON.stringify(sys)); } catch {}
        try { stompClient.disconnect(); } catch {}
      }
    });

    window.addEventListener('load', connect);
  </script>
</body>
</html>
